@inject IJsonStringLocalizer<BlogSettings> Localizer
@inject Sotsera.Blazor.Toaster.IToaster Toaster
@inject IHttpContextAccessor HttpContextAccessor
@inject CustomHttpClient Http

@inject Microsoft.FeatureManagement.IFeatureManager FeatureManager
@{
    var isDemo = FeatureManager.IsEnabledAsync(nameof(AppFeatureFlags.DemoMode)).Result;
}

@if (Model != null)
{
    <EditForm Model="@Model" OnValidSubmit="SaveScripts">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="app-settings-title">Scripts Settings</div>
        <div class="alert alert-secondary" role="alert">
            <a href="https://github.com/blogifierdotnet/Blogifier/blob/master/docs/ScriptIncludes.md" target="_blank">
                <i class="fas fa-info-circle"></i>
            </a>
            @Localizer["include-scripts"]
        </div>
        <div class="form-group">
            <label class="form-control-label">Header script</label>
            <textarea readonly="@(isDemo)" class="form-control txt-area" rows="4" @bind="Model.HeaderScript" name="headerScript" />
        </div>
        <div class="form-group">
            <label class="form-control-label">Footer script</label>
            <textarea readonly="@(isDemo)" class="form-control txt-area" rows="10" @bind="Model.FooterScript" name="footerScrip" />
        </div>
        <div class="form-submit-button">
            <input type="submit" disabled="@(isDemo)" value="@Localizer["save"]" class="btn btn-brand" />
        </div>
    </EditForm>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    protected HttpRequest Request { get; set; }

    protected BlogItem Model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Request = HttpContextAccessor.HttpContext.Request;
        Model = await Http.GetJsonAsync<BlogItem>($"settings", Request);
    }

    protected async Task SaveScripts()
    {
        await Http.PostJsonAsync<BlogItem>($"settings", Request, Model);
        Toaster.Success("Saved");
    }
}
