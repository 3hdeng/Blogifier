@inject IJsonStringLocalizer<BlogSettings> Localizer
@inject Sotsera.Blazor.Toaster.IToaster Toaster
@inject IHttpContextAccessor HttpContextAccessor
@inject CustomHttpClient Http

@inject Microsoft.FeatureManagement.IFeatureManager FeatureManager
@{
    var isDemo = FeatureManager.IsEnabledAsync(nameof(AppFeatureFlags.DemoMode)).Result;
}

@if (Model != null)
{
    <div class="card">
        <div class="card-body">
            <EditForm Model="@Model" OnValidSubmit="SaveScripts">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <fieldset>
                    <div class="alert alert-info" role="alert">
                        <a href="https://github.com/blogifierdotnet/Blogifier/blob/master/docs/ScriptIncludes.md" target="_blank">
                            <i class="fa fa-info-circle"></i>
                        </a>
                        @Localizer["include-scripts"]
                    </div>
                    <div class="input-group">
                        <textarea readonly="@(isDemo)" class="form-control txt-area" rows="4" @bind="Model.HeaderScript" name="headerScript" placeholder="Header script" />
                    </div>
                    <div class="input-group">
                        <textarea readonly="@(isDemo)" class="form-control txt-area" rows="10" @bind="Model.FooterScript" name="footerScrip" placeholder="Footer script" />
                    </div>
                    <div>
                        <label>&nbsp;</label>
                        <input type="submit" disabled="@(isDemo)" value="@Localizer["save"]" class="btn btn-primary" />
                    </div>
                </fieldset>
            </EditForm>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    protected HttpRequest Request { get; set; }

    protected BlogItem Model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Request = HttpContextAccessor.HttpContext.Request;
        Model = await Http.GetJsonAsync<BlogItem>($"settings", Request);
    }

    protected async Task SaveScripts()
    {
        await Http.PostJsonAsync<BlogItem>($"settings", Request, Model);
        Toaster.Success("Saved");
    }
}
